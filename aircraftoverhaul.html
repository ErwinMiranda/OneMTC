<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>One MTC</title>
    <link rel="stylesheet" href="onemtc.css" />
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.1/clusterize.min.js"></script>
  </head>
  <body>
    <div class="plan-header">
      <div class="plan-heading" id="dynamicHeader">No Data</div>
      <span id="lastUpdate" class="liveUpdate"></span>
      <button onclick="logout()" class="logout-btn">Logout</button>
    </div>

    <div class="main-wrapper">
      <!-- Left side main content -->
      <div class="main-content">
        <div class="controls">
          <input type="text" id="woInput" placeholder="Enter Workorder" />
          <button class="btn" id="woSearchBtn">Search</button>

          <button
            class="btn"
            id="startScanBtn"
            title="Activate barcode scanner"
          >
            Scan Here!
          </button>
          <button
            class="btn"
            id="stopScanBtn"
            title="Stop scanner"
            style="display: none"
          >
            Stop Scan
          </button>

          <!-- Hidden input to capture scanner keystrokes -->
          <label for="barcodeInput" style="display: none">Barcode Input</label>
          <input
            type="text"
            id="barcodeInput"
            name="barcodeInput"
            autocomplete="off"
            placeholder="Scan or enter barcode"
            title="Scan or enter barcode here"
          />
        </div>

        <div class="skill-filters" id="skillFilters"></div>

        <div id="counter">Waiting for input...</div>
        <button id="multiSkillBtn" class="pill-btn">Multiskill MTC</button>
        <button id="singleSkillBtn" class="pill-btn">Single Skill MTC</button>

        <div class="layout">
          <!-- Phase totals and chart (responsive side-by-side) -->
          <!-- STYLES MOVED TO CSS -->
          <div id="phaseTotalsWrapper">
            <!-- üìä Phase Table -->
            <div id="phaseTotalsContainer">
              <table
                id="phaseTotalsTable"
                style="width: 100%; border-collapse: collapse"
              >
                <thead>
                  <tr>
                    <th>Phase</th>
                    <th style="text-align: right">Open Tasks</th>
                    <th style="text-align: right">Closed Tasks</th>
                    <th style="text-align: right">Cancelled Tasks</th>
                    <th style="text-align: right">Hold Tasks</th>
                    <th style="text-align: right">% Closed</th>
                  </tr>
                </thead>
                <tbody id="phaseTotalsBody">
                  <tr>
                    <td colspan="6" style="text-align: center">No data</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div id="phaseChartContainer">
              <canvas id="phaseChart"></canvas>
            </div>

            <div id="jcChartContainer">
              <canvas id="jcChart"></canvas>
            </div>
          </div>
          <!-- hidden badge container -->
          <div id="dynamicBadgeContainer" style="display: none"></div>
          <!-- Main scrollable table -->
          <div id="scrollArea">
            <table>
              <thead>
                <tr>
                  <th style="width: 160px">Reference</th>
                  <th>Description</th>
                  <th style="width: 50px">Seq.No</th>
                  <th style="width: 70px">Status</th>
                  <th style="width: 160px">TaskCard Items</th>
                  <th style="width: 160px">Comments</th>
                  <th style="width: 40px"></th>
                  <th style="width: 40px"></th>
                  <th style="width: 40px"></th>
                  <th style="width: 40px"></th>
                  <th style="width: 40px"></th>
                  <th style="width: 40px"></th>
                  <th style="width: 40px"></th>
                </tr>
                <tr>
                  <th>
                    <input
                      type="text"
                      class="filter"
                      data-field="reference_task_card"
                      placeholder="Search Reference"
                    />
                  </th>
                  <th>
                    <input
                      type="text"
                      class="filter"
                      data-field="task_card_description"
                      placeholder="Search Description"
                    />
                  </th>
                  <th>
                    <input
                      type="text"
                      class="filter"
                      data-field="seq"
                      placeholder="Search Seq"
                      style="padding-right: 18px"
                    />
                    <!-- STYLE MOVED TO CSS -->
                    <button id="clearSeqBtn">‚úñ</button>
                  </th>
                  <th>
                    <input
                      type="text"
                      class="filter"
                      data-field="status"
                      placeholder="Search Status"
                    />
                  </th>
                  <th>
                    <input
                      type="text"
                      class="filter"
                      data-field="task_card"
                      placeholder="Search TaskCard Items"
                    />
                  </th>
                  <th>
                    <button id="manualTrigger" class="cmnt-btn">
                      All Comments
                    </button>
                  </th>
                  <th>PH</th>
                  <th>P1</th>
                  <th>P2</th>
                  <th>P3</th>
                  <th>P4</th>
                  <th>P6</th>
                  <th>P0</th>
                </tr>
              </thead>
              <tbody id="contentArea" class="clusterize-content">
                <tr class="clusterize-no-data">
                  <td colspan="12">No data yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <button onclick="printFullTable()" class="printable">
          üñ®Ô∏è Print This Table
        </button>
        <button id="logbookBtn" class="logbook-btn">Turnover Logbook</button>

        <button
          id="dashboardToggleBtn"
          class="logbook-btn"
          style="
            background-color: var(--lufthansa-yellow);
            color: var(--lufthansa-blue);
          "
        >
          Discrepant Dashboard
        </button>

        <!-- Scan Modal -->
        <div
          id="scanModal"
          role="dialog"
          aria-modal="true"
          aria-labelledby="scanModalTitle"
        >
          <div class="modal-content">
            <h3 id="scanModalTitle">Scanned Sequences</h3>
            <div style="font-size: 12px; color: #555">
              WO: <span id="activeWO" class="pill">‚Äî</span> ‚Ä¢ Count:
              <span id="scanCount" class="pill">0</span>
              <span style="padding-left: 20px; float: right">
                <label
                  class="switch"
                  style="margin-right: 8px"
                  title="Toggle to show/hide already closed tasks"
                >
                  <input type="checkbox" id="showClosedChk" />
                  <span class="slider round"></span>
                </label>
                <span> Re-open Task Item(s)</span>
              </span>
            </div>

            <!-- Manual input for seq number -->
            <div id="manualInputContainer">
              <label for="manualSeqInput" style="display: none">
                Manual Seq Number
              </label>
              <input
                type="number"
                id="manualSeqInput"
                name="manualSeqInput"
                placeholder="Enter Seq Number"
                title="Enter sequence number manually"
              />
              <button id="manualAddBtn" title="Add entered sequence number">
                Add
              </button>
            </div>

            <!-- Search results for scanned/typed seq -->
            <div style="margin-top: 10px">
              <h4 style="font-size: 13px; margin-bottom: 5px; color: #444">
                Matching Tasks
              </h4>
              <table class="scan-table">
                <thead>
                  <tr>
                    <th>Seq</th>
                    <th>Task Items</th>
                    <th>Phase</th>
                    <th>Skill</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="scanResultsList"></tbody>
              </table>
            </div>

            <!-- Queue of tasks to close -->
            <div style="margin-top: 15px">
              <h4 style="font-size: 13px; margin-bottom: 5px; color: #444">
                Queued Tasks
              </h4>
              <table class="scan-table">
                <thead>
                  <tr>
                    <th>Seq</th>
                    <th>Task Items</th>
                    <th>Phase</th>
                    <th>Skill</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="scannedList"></tbody>
              </table>
            </div>

            <div class="modal-actions">
              <button
                class="btn"
                id="submitScanBtn"
                title="Update queued tasks to CLOSED"
              >
                Submit
              </button>
              <button class="btn" id="clearScanBtn" title="Clear list">
                Clear
              </button>
              <button class="btn" id="closeScanBtn" title="Close modal">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right side history panel -->
      <div class="history" id="historyPanel">
        <h3
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            Updates
            <span
              id="historyBadge"
              class="notification-badge"
              style="display: none"
            ></span>
          </div>

          <button
            id="clearNotifBtn"
            class="pill-btn"
            style="margin: 0; padding: 4px 10px; font-size: 12px"
          >
            Clear Notifications
          </button>
        </h3>

        <div id="historyScrollArea" class="history-list-scroll">
          <ul id="historyList" class="history-list">
            <li class="clusterize-no-data">Waiting for updates...</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Loading -->
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div>Loading, please wait...</div>
    </div>
    <!-- Toast Notifications -->
    <div id="toastContainer"></div>
    <!-- Discrepancy Modal -->
    <!-- Discrepancy Modal -->
    <div id="discrepancyModal" class="modern-modal">
      <div class="modern-modal-card">
        <div class="modern-modal-header">
          <h3>Report Discrepancy</h3>
        </div>

        <div class="form-group">
          <label>Discrepancy Type</label>
          <select id="discType">
            <option value="Incomplete signature-stamp-date">
              Incomplete signature-stamp-date
            </option>
            <option value="Incomplete forms">Incomplete forms</option>
            <option value="Voiding and Card Handling Issues">
              Voiding and Card Handling Issues
            </option>
            <option value="Customer Findings and Reporting Issues">
              Customer Findings and Reporting Issues
            </option>
            <option value="Cards Status In Progress">
              Cards Status In Progress
            </option>
            <option value="Document Quality Issues">
              Document Quality Issues
            </option>
            <option value="Reopened/Pulled Out Tasks and Documents">
              Reopened/Pulled Out Tasks and Documents
            </option>
            <option value="Missing-Incorrect Data">
              Missing-Incorrect Data
            </option>
            <option value="NR Work Accomplishment not encoded">
              NR Work Accomplishment not encoded
            </option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Remarks</label>
          <textarea id="discRemarks" rows="3"></textarea>
        </div>

        <div class="modern-actions">
          <button id="closeDiscBtn" class="btn-secondary">Cancel</button>
          <button id="saveDiscBtn" class="btn-primary">Save</button>
        </div>
      </div>
    </div>

    <script type="module" src="onemtc.js"></script>
  </body>
</html>
