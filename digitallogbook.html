<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Turnover Logbook — Lufthansa</title>
    <script type="module">
      import { requireLogin, logout } from "./auth.js";
      requireLogin();
      window.logout = logout;
    </script>
  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --lh-blue:#021a4b;
      --lh-yellow:#ffcc00;
      --muted:#6b7280;
      --bg:#f4f7fb;
      --card:#ffffff;
      --border:#e6eefc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:#0b2242;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Header */
    header{
      background:var(--lh-blue);
      color:white;
      padding:16px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:20px;
    }
    header .left{display:flex;align-items:center;gap:16px}
    header h1{font-size:1.05rem;margin:0;font-weight:600;letter-spacing:0.2px}
    header .small{font-size:0.85rem;color:rgba(255,255,255,0.9)}

    /* Toolbar */
    .toolbar{
      max-width:1100px;
      margin:18px auto 0;
      width:calc(100% - 48px);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], select, input[type="date"]{
      padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:white;
      font-size:0.95rem;
    }
    button.btn{
      background:var(--lh-blue);color:white;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;
    }
    button.ghost{
      background:transparent;color:var(--lh-blue);border:1px solid rgba(11,34,66,0.08);
    }
    .primary-yellow{
      background:linear-gradient(90deg,var(--lh-yellow),#ffd34d); color:var(--lh-blue);
    }

    /* Page content */
    main{
      max-width:1100px;margin:18px auto;padding:18px;width:calc(100% - 48px);flex:1;display:flex;flex-direction:column;gap:14px;
    }

    .panel{
      background:var(--card);border-radius:10px;padding:14px;border:1px solid var(--border);
      box-shadow:0 2px 6px rgba(2,26,75,0.03);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:18px;
      align-items:start;
    }

    /* Log list */
    .log-list{display:flex;flex-direction:column;gap:12px}
    .log-item{
      border-radius:8px;padding:12px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fbfdff);
      display:flex;flex-direction:column;gap:8px;
    }
    .meta{
      display:flex;justify-content:space-between;align-items:center;gap:10px;font-size:0.9rem;color:var(--muted);
    }
    .meta-left{display:flex;gap:10px;align-items:center}
    .chip{
      font-size:0.82rem;padding:4px 8px;border-radius:999px;background:#f1f6ff;color:var(--lh-blue);font-weight:600;
    }
    .remarks{font-size:0.95rem;color:#16324b;white-space:pre-wrap}

    /* Form */
    .form-row{display:flex;flex-direction:column;gap:8px}
    label{font-size:0.85rem;color:var(--muted)}
    textarea{min-height:120px;padding:10px;border-radius:8px;border:1px solid var(--border);font-size:0.95rem}

    /* actions */
    .actions{display:flex;gap:8px;align-items:center}
    .small-btn{padding:6px 10px;border-radius:8px;border:none;background:#0b2f66;color:white;cursor:pointer;font-weight:600}

    /* modal */
    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,26,75,0.36);
      z-index:9999;padding:24px;
    }
    .modal.show{display:flex}
    .modal-card{background:white;border-radius:10px;padding:18px;width:100%;max-width:600px;box-shadow:0 8px 30px rgba(2,26,75,0.12)}
    .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modal-row{display:flex;flex-direction:column;gap:6px}

    /* responsive */
    @media (max-width:880px){
      .grid{grid-template-columns:1fr}
      .toolbar{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
 <header>
      <div class="left">
        <h1>Digital Turnover Logbook</h1>
        <div class="small" id="header-wo">—</div>
      </div>
      <div class="small">Last modified logs are editable</div>
    </header>

    <!-- Toolbar / Filters -->
    <div class="toolbar">
      <div class="controls">
        <input
          type="text"
          id="input-wo"
          placeholder="Workorder (auto)"
          readonly
        />
        <input type="text" id="select-skill" readonly />

        <input type="date" id="input-date" />
        <button class="btn" id="btn-load">Load</button>
      </div>

      <div class="controls">
        <input
          type="text"
          id="input-filter"
          placeholder="Search seq / NR / remarks..."
        />
        <button class="ghost" id="btn-export">Export CSV</button>
        <button class="primary-yellow" id="btn-add">+ Add Turnover</button>
      </div>
    </div>

    <main>
      <div class="grid">
        <!-- left: logs -->
        <div class="panel">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <div style="font-weight: 600">Turnover entries</div>
            <div style="font-size: 0.9rem; color: var(--muted)" id="count-info">
              —
            </div>
          </div>

          <div class="log-list" id="log-list">
            <div style="text-align: center; color: var(--muted)">
              No logs loaded. Select WO / skill / date and click Load.
            </div>
          </div>
        </div>

        <!-- right: quick form & summary -->
        <div class="panel">
          <div style="font-weight: 600; margin-bottom: 8px">Quick Add</div>
          <div class="form-row">
            <label>WO</label>
            <input
              type="text"
              id="form-wo"
              placeholder="Workorder (auto)"
              readonly
            />
          </div>
          <div class="form-row">
            <label>Skill</label>
            <input type="text" id="form-skill" readonly />
          </div>
          <div class="form-row">
            <label>Seq / NR (e.g., 123 or NR-00001)</label>
            <input type="text" id="form-seq" placeholder="Seq or NR-" />
          </div>
          <div class="form-row">
            <label>Remarks</label>
            <textarea
              id="form-remarks"
              placeholder="Enter turnover notes..."
            ></textarea>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px">
            <button class="btn" id="form-save">Save</button>
            <button class="ghost" id="form-clear">Clear</button>
          </div>

          <hr
            style="
              margin: 14px 0;
              border: none;
              border-top: 1px solid var(--border);
            "
          />

          <div style="font-weight: 600; margin-bottom: 8px">
            Shift Summary (by skill)
          </div>
          <div id="summary" style="font-size: 0.95rem; color: var(--muted)">
            —
          </div>
        </div>
      </div>
    </main>

    <!-- Add/Edit Modal -->
    <div class="modal" id="modal">
      <div class="modal-card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <div style="font-weight: 700" id="modal-title">New Turnover</div>
          <button id="modal-close" class="ghost" style="padding: 6px 8px">
            Close
          </button>
        </div>

        <div class="modal-grid">
          <div class="modal-row">
            <label>WO</label>
            <input id="m-wo" type="text" readonly />
          </div>
          <div class="modal-row">
            <label>Skill</label>
            <input type="text" id="m-skill" readonly />
          </div>

          <div class="modal-row" style="grid-column: 1 / -1">
            <label>Seq or NR</label>
            <input id="m-seq" type="text" />
          </div>

          <div class="modal-row" style="grid-column: 1 / -1">
            <label>Remarks</label>
            <textarea id="m-remarks" rows="6"></textarea>
          </div>
        </div>

        <div
          style="
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px;
          "
        >
          <button id="modal-delete" class="ghost" style="color: #b00">
            Delete
          </button>
          <button id="modal-save" class="btn">Save</button>
        </div>
      </div>
    </div>

  <!-- Firestore + App script -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- ✅ Fixed Firebase Logic -->
    <script type="module">
      import { logout } from "./auth.js";

      window.logout = logout; // 👈 exposes it globally
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        writeBatch,
        onSnapshot,
        query,
        where,
        orderBy,
        getDocs,
        serverTimestamp,
        addDoc,
        updateDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDCpHhUL8x4rs-fom1xyaNdWm5prSGf57U",
        authDomain: "onemtc-2222c.firebaseapp.com",
        projectId: "onemtc-2222c",
        storageBucket: "onemtc-2222c.appspot.com",
        messagingSenderId: "447271556426",
        appId: "1:447271556426:web:562ba4d72e40b754599db3",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // ✅ Redirect user to login page if not signed in
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          console.log("⚠️ No user signed in. Redirecting to login...");
          window.location.href = "index";
        } else {
          console.log(`✅ Logged in as: ${user.email || "Anonymous"}`);
          localStorage.setItem("userEmail", user.email || "Anonymous");

          // Optionally show email in UI
          const userDisplay = document.getElementById("userDisplay");
          if (userDisplay) userDisplay.textContent = user.email || "Anonymous";
        }
      });

      /* ---------- Helpers & state ---------- */
      const $ = (id) => document.getElementById(id);
      const inputWO = $("input-wo");
      const selectSkill = $("select-skill");
      const inputDate = $("input-date");
      const btnLoad = $("btn-load");
      const listEl = $("log-list");
      const countInfo = $("count-info");
      const filterInput = $("input-filter");
      const btnAdd = $("btn-add");
      const btnExport = $("btn-export");

      const formWO = $("form-wo");
      const formSkill = $("form-skill");
      const formSeq = $("form-seq");
      const formRemarks = $("form-remarks");
      const formSave = $("form-save");
      const formClear = $("form-clear");

      const modal = $("modal");
      const modalClose = $("modal-close");
      const modalTitle = $("modal-title");
      const mWo = $("m-wo");
      const mSkill = $("m-skill");
      const mSeq = $("m-seq");
      const mRemarks = $("m-remarks");
      const modalSave = $("modal-save");
      const modalDelete = $("modal-delete");

      let editingDocId = null;
      let currentWO = null;
      let currentSkill = null;

      // read WO & skill from URL params or fallback to localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const paramWO = urlParams.get("wo");
      const paramSkill = urlParams.get("skill");

      // try localStorage fallback keys (from your monitoring app you may store lastWorkorder/currentWO/activeSkill)
      const lsWO =
        localStorage.getItem("lastWorkorder") ||
        localStorage.getItem("currentWO") ||
        null;

      // ✅ Read skill from localStorage (and nullify CLEAR)
      let localSkill = localStorage.getItem("activeSkill");
      if (localSkill === "CLEAR") localSkill = null;

      // ✅ Determine the active skill (param overrides localStorage)
      currentSkill = paramSkill || localSkill || null;
      currentWO = paramWO || lsWO || "";

      // ✅ Update all visible skill fields

      const skillDisplay = currentSkill || "No Skill";
      document.getElementById("select-skill").value = skillDisplay;
      document.getElementById("form-skill").value = skillDisplay;
      document.getElementById("m-skill").value = skillDisplay;

      // ✅ Update WO header
      inputWO.value = currentWO;
      formWO.value = currentWO;
      $("header-wo").textContent = currentWO ? `WO: ${currentWO}` : "No WO";

      // default date = today
      const today = new Date();
      function toYMD(d) {
        const z = (n) => (n < 10 ? "0" + n : n);
        return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}`;
      }
      inputDate.value = toYMD(today);

      // search debounce helper
      let searchTimer = null;

      /* ---------- Firestore operations ---------- */
      async function loadLogs() {
        const wo = inputWO.value.trim();
        const skill =
          localStorage.getItem("activeSkill") === "CLEAR"
            ? null
            : localStorage.getItem("activeSkill");

        const date = inputDate.value;
        const search = filterInput.value.trim().toLowerCase();

        if (!wo) {
          alert("Please set WO (from monitoring app or URL).");
          return;
        }
        if (!skill) {
          alert("Please pick a Skill to view.");
          return;
        }
        if (!date) {
          alert("Please pick a Date.");
          return;
        }

        currentWO = wo;
        currentSkill = skill;

        // Save to localStorage so next time the monitoring app can re-use
        localStorage.setItem("lastWorkorder", currentWO);
        localStorage.setItem("activeSkill", currentSkill);

        // Build query: equality filters for WO, skill and date string
        const col = collection(db, "turnover");
        // We store a 'date' field as YYYY-MM-DD to make date filtering simple
        const q = query(
          col,
          where("wo", "==", currentWO),
          where("skill", "==", currentSkill),
          where("date", "==", date),
          orderBy("modified_at", "asc")
        );
        const snap = await getDocs(q);

        listEl.innerHTML = "";
        let count = 0;
        const rows = [];

        snap.forEach((docSnap) => {
          const data = docSnap.data();
          data.__id = docSnap.id;
          rows.push(data);
        });

        // client-side search filter if search text present (search seq_or_nr and remarks)
        const filtered = rows.filter((r) => {
          if (!search) return true;
          const concat = `${r.seq_or_nr || ""} ${
            r.remarks || ""
          }`.toLowerCase();
          return concat.includes(search);
        });

        if (filtered.length === 0) {
          listEl.innerHTML = `<div style="text-align:center;color:var(--muted);padding:18px">No logs for ${currentWO} · ${currentSkill} · ${date}</div>`;
          countInfo.textContent = `0 entries`;
          return;
        }

        filtered.forEach((r) => {
          count++;
          const item = document.createElement("div");
          item.className = "log-item";
          item.innerHTML = `
          <div class="meta">
            <div class="meta-left">
              <div style="font-weight:700">${r.seq_or_nr || "—"}</div>
              <div class="chip">${r.skill}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:0.9rem;color:var(--muted)">${
                r.logged_by || r.modified_by || "—"
              }</div>
              <div style="font-size:0.85rem;color:var(--muted)">${
                r.modified_at
                  ? new Date(r.modified_at.seconds * 1000).toLocaleString()
                  : "-"
              }</div>
            </div>
          </div>
          <div class="remarks">${escapeHtml(r.remarks || "")}</div>
          <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button class="edit-btn" data-id="${r.__id}">Edit</button>
          </div>
        `;
          listEl.appendChild(item);
        });

        countInfo.textContent = `${count} entries`;
      }

      // Save quick form
      formSave.addEventListener("click", async () => {
        const wo = formWO.value.trim() || inputWO.value.trim();
        const skill =
          localStorage.getItem("activeSkill") === "CLEAR"
            ? null
            : localStorage.getItem("activeSkill");

        const seq = formSeq.value.trim();
        const remarks = formRemarks.value.trim();
        const date = inputDate.value;

        if (!wo || !skill || !date || !remarks) {
          alert("Please fill WO, skill, date and remarks.");
          return;
        }

        const payload = {
          wo,
          skill,
          seq_or_nr: seq || "",
          remarks,
          logged_by: localStorage.getItem("userEmail") || "Unknown",
          modified_by: localStorage.getItem("userEmail") || "Unknown",
          date,
          modified_at: serverTimestamp(),
        };

        await addDoc(collection(db, "turnover"), payload);
        // clear quick form
        formSeq.value = "";
        formRemarks.value = "";
        // reload
        loadLogs();
      });

      formClear.addEventListener("click", () => {
        formSeq.value = "";
        formRemarks.value = "";
        formSkill.value = selectSkill.value || "";
      });

      // Open add modal
      btnAdd.addEventListener("click", () => {
        editingDocId = null;
        modalTitle.textContent = "New Turnover Entry";
        mWo.value = inputWO.value || formWO.value || "";
        mSkill.value = selectSkill.value || formSkill.value || "";
        mSeq.value = "";
        mRemarks.value = "";
        modal.classList.add("show");
      });

      // Modal close & save & delete
      modalClose.addEventListener("click", () =>
        modal.classList.remove("show")
      );

      modalSave.addEventListener("click", async () => {
        const wo = mWo.value.trim();
        const skill = mSkill.value.trim();
        const seq = mSeq.value.trim();
        const remarks = mRemarks.value.trim();
        const date = inputDate.value;

        if (!wo || !skill || !date || !remarks) {
          alert("Please fill WO, skill, date and remarks.");
          return;
        }

        const payload = {
          wo,
          skill,
          seq_or_nr: seq || "",
          remarks,
          modified_by: localStorage.getItem("userEmail") || "Unknown",
          date,
          modified_at: serverTimestamp(),
        };

        if (editingDocId) {
          // update
          const ref = doc(db, "turnover", editingDocId);
          await updateDoc(ref, payload);
        } else {
          await addDoc(collection(db, "turnover"), payload);
        }

        modal.classList.remove("show");
        loadLogs();
      });

      // Delete button in modal
      modalDelete.addEventListener("click", async () => {
        if (!editingDocId) return;
        if (!confirm("Delete this turnover entry?")) return;
        await deleteDoc(doc(db, "turnover", editingDocId));
        modal.classList.remove("show");
        loadLogs();
      });

      // open edit workflow - uses doc id
      async function openEdit(docId) {
        editingDocId = docId;
        modalTitle.textContent = "Edit Turnover Entry";

        try {
          const dRef = doc(db, "turnover", docId);
          const snap = await getDoc(dRef);

          if (!snap.exists()) {
            alert("Document not found");
            return;
          }

          // ✅ define data only after snapshot is retrieved
          const data = snap.data();

          mWo.value = data.wo || inputWO.value || formWO.value || "";
          mSkill.value =
            data.skill || localStorage.getItem("activeSkill") || "No Skill";
          mSeq.value = data.seq_or_nr || "";
          mRemarks.value = data.remarks || "";

          modal.classList.add("show");
        } catch (err) {
          console.error("Error loading document for edit:", err);
          alert("Failed to load entry for edit");
        }
      }

      // delegate edit button clicks in the log list
      listEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button.edit-btn");
        if (!btn) return;
        const id = btn.dataset.id;
        if (!id) return;
        openEdit(id);
      });

      // search debounce
      filterInput.addEventListener("input", () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(loadLogs, 350);
      });

      // binding load button
      btnLoad.addEventListener("click", loadLogs);

      // Export CSV
      btnExport.addEventListener("click", async () => {
        const wo = inputWO.value.trim();
        const skill =
          localStorage.getItem("activeSkill") === "CLEAR"
            ? null
            : localStorage.getItem("activeSkill");

        const date = inputDate.value;
        if (!wo || !skill || !date) {
          alert("Please pick WO/skill/date before exporting");
          return;
        }
        const col = collection(db, "turnover");
        const q = query(
          col,
          where("wo", "==", wo),
          where("skill", "==", skill),
          where("date", "==", date),
          orderBy("modified_at", "asc")
        );
        const snap = await getDocs(q);
        const rows = [];
        snap.forEach((s) => {
          const d = s.data();
          rows.push([
            d.seq_or_nr || "",
            d.skill || "",
            (d.remarks || "").replace(/\n/g, " "),
            d.logged_by || d.modified_by || "",
            d.date || "",
            d.modified_at
              ? new Date(d.modified_at.seconds * 1000).toLocaleString()
              : "",
          ]);
        });
        if (rows.length === 0) {
          alert("No data to export");
          return;
        }
        // CSV
        const header = [
          "Seq/NR",
          "Skill",
          "Remarks",
          "User",
          "Date",
          "Modified At",
        ];
        const csv = [header, ...rows]
          .map((r) =>
            r
              .map((cell) => `"${String(cell || "").replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `turnover_${wo}_${skill}_${date}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      // keyboard: Enter in quick form saves
      formRemarks.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "Enter") formSave.click();
      });

      // utility: escape HTML when rendering remarks
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      // initial UI population
      (function init() {
        // map incoming skill param into dropdown if custom

        // set WO fields
        if (currentWO) {
          inputWO.value = currentWO;
          formWO.value = currentWO;
          mWo.value = currentWO;
        }

        // ensure date default
        if (!inputDate.value) inputDate.value = toYMD(new Date());

        // load initial list if enough inputs are set
        // We won't auto-load unless user clicks Load to avoid accidental heavy reads
      })();

      // helper for toYMD defined earlier in CSS block? define now:

      // expose loadLogs globally for convenience
      window.loadTurnoverLogs = loadLogs;
    </script>
  </body>
</html>
